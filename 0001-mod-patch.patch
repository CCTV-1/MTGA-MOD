From 43882a24e30ce58fd832ea25bc0f67f6c99b9ae8 Mon Sep 17 00:00:00 2001
From: CCTV-1 <script.tar.gz@gmail.com>
Date: Mon, 13 Feb 2023 12:11:06 +0800
Subject: [PATCH] mod patch.

---
 AbilityHangerBase.cs                          |   1 +
 AccountInformation.cs                         |   2 +-
 AutoLandsToggle.cs                            |   6 +
 CDCPart_TextBox_DayNight.cs                   |   4 +-
 CDCPart_TextBox_Dungeon.cs                    |   5 +-
 .../MasteryEndText.cs                         |   1 +
 DeckBuilderWidget.cs                          | 122 ++++----
 DeckMainTitlePanel.cs                         |   5 +
 DeckManagerController.cs                      |  10 +-
 DirectChallengeBladeWidget.cs                 |   1 +
 FriendChallengeBladeWidget.cs                 |   1 +
 GreClient.CardData/CardUtilities.cs           |  10 +-
 MTGA.Loc/MTGALocalizable.cs                   |  15 +-
 MatchManager.cs                               |   5 -
 Meta_CDC.cs                                   |  11 +
 ModManager.cs                                 | 295 ++++++++++++++++++
 SearchAndFilterBar.cs                         |   1 +
 SetCollectionScreenView.cs                    |   1 +
 SettingsPanelGraphics.cs                      |   2 +-
 Spinner_OptionSelector.cs                     |   1 +
 StoreItemBase.cs                              |   1 +
 SystemMessageView.cs                          |   3 +
 .../CDCExtraFrameDetailFiller.cs              |   1 +
 .../FieldFillerUtils.cs                       |   8 +-
 .../ClassAbilityTextbox.cs                    |   5 +
 .../TableAbilityTextbox.cs                    |   3 +-
 .../TextboxSubComponentBase.cs                |   9 +-
 Wotc.Mtga.Cards.Text/Utilities.cs             |  11 +-
 Wotc.Mtga.Loc/Languages.cs                    |   2 +-
 .../DraftContentController.cs                 |  28 +-
 Wotc.Mtga.Wrapper.Draft/HumanDraftPod.cs      |   1 +
 WrapperDeckBuilder.cs                         |   2 +-
 WrapperDeckUtilities.cs                       |  29 +-
 33 files changed, 472 insertions(+), 130 deletions(-)
 create mode 100644 ModManager.cs

diff --git a/AbilityHangerBase.cs b/AbilityHangerBase.cs
index a909672..0a2efa8 100644
--- a/AbilityHangerBase.cs
+++ b/AbilityHangerBase.cs
@@ -215,6 +215,7 @@ public class AbilityHangerBase : HangerBase
 	protected virtual void AddHangersInternal(BASE_CDC cardView, ICardDataAdapter sourceModel, HangerSituation situation)
 	{
 		ICardDataAdapter model = cardView.Model;
+		this._view.CreateHangerItem("GrpId", false, model.GrpId.ToString(), false, "", false, null, 0, false, false, false);
 		if (model.IsFakeStyleCard)
 		{
 			_view.CreateHangerCardStyle();
diff --git a/AccountInformation.cs b/AccountInformation.cs
index 8249116..f0e33a2 100644
--- a/AccountInformation.cs
+++ b/AccountInformation.cs
@@ -64,7 +64,7 @@ public class AccountInformation
 
 	public bool HasRole_MythicOrange()
 	{
-		return Roles.Contains("WotC_REP", StringComparison.InvariantCultureIgnoreCase);
+		return true;
 	}
 
 	public bool HasRole_Debugging()
diff --git a/AutoLandsToggle.cs b/AutoLandsToggle.cs
index 370d03f..f5a3d6e 100644
--- a/AutoLandsToggle.cs
+++ b/AutoLandsToggle.cs
@@ -1,5 +1,6 @@
 using System;
 using GreClient.CardData;
+using TMPro;
 using UnityEngine;
 using Wotc.Mtga.Extensions;
 
@@ -40,6 +41,11 @@ public class AutoLandsToggle : MonoBehaviour
 			deckBuilderWidget.CardRemovedFromMainDeck += _onCardRemovedFromMainDeck;
 			filterBar.LandFilterValueChanged += _onFilterValueChanged;
 			cardPoolHolder.OnPageChanged += _onPageChanged;
+			Transform transform = base.transform.FindChild("Text");
+			if (transform != null)
+			{
+				transform.GetComponent<TextMeshProUGUI>().font = ModManager.Instance.zhCNFont;
+			}
 			_isInitialized = true;
 		}
 	}
diff --git a/CDCPart_TextBox_DayNight.cs b/CDCPart_TextBox_DayNight.cs
index fe4c749..65dfb9b 100644
--- a/CDCPart_TextBox_DayNight.cs
+++ b/CDCPart_TextBox_DayNight.cs
@@ -19,8 +19,8 @@ public class CDCPart_TextBox_DayNight : CDCPart_Textbox_SuperBase
 	protected override void HandleUpdateInternal()
 	{
 		base.HandleUpdateInternal();
-		_upperTextLabel.font = _fontAsset;
-		_lowerTextLabel.font = _fontAsset;
+		_upperTextLabel.font = ModManager.Instance.zhCNFont;
+		_lowerTextLabel.font = ModManager.Instance.zhCNFont;
 		_upperTextLabel.fontSize = _supportedFontSizes[0];
 		_lowerTextLabel.fontSize = _supportedFontSizes[0];
 		UpdateLabelMaterial(_upperTextLabel);
diff --git a/CDCPart_TextBox_Dungeon.cs b/CDCPart_TextBox_Dungeon.cs
index d6c903d..6ffbd00 100644
--- a/CDCPart_TextBox_Dungeon.cs
+++ b/CDCPart_TextBox_Dungeon.cs
@@ -48,15 +48,14 @@ public class CDCPart_TextBox_Dungeon : CDCPart_Textbox_SuperBase
 				}
 			}
 		}
-		TMP_FontAsset titleFont = GetTitleFont();
-		TMP_FontAsset fontAsset = _fontAsset;
+		TMP_FontAsset zhCNFont = ModManager.Instance.zhCNFont;
 		for (int i = 0; i < _cachedLabelStrings.Count && i < _dungeonRooms.Count; i++)
 		{
 			(string, string) tuple = _cachedLabelStrings[i];
 			string item4 = tuple.Item1;
 			string item5 = tuple.Item2;
 			DungeonRoomTextbox dungeonRoomTextbox = _dungeonRooms[i];
-			dungeonRoomTextbox.SetFont(titleFont, fontAsset);
+			dungeonRoomTextbox.SetFont(zhCNFont, zhCNFont);
 			dungeonRoomTextbox.SetLabels(item4, item5);
 		}
 		_activeRoomArray[0] = CurrentRoomGrpId(_cachedModel);
diff --git a/Core.Meta.MainNavigation.Profile/MasteryEndText.cs b/Core.Meta.MainNavigation.Profile/MasteryEndText.cs
index 590b658..9185b34 100644
--- a/Core.Meta.MainNavigation.Profile/MasteryEndText.cs
+++ b/Core.Meta.MainNavigation.Profile/MasteryEndText.cs
@@ -22,6 +22,7 @@ namespace Core.Meta.MainNavigation.Profile
 				if (text == null)
 				{
 					text = GetComponent<TMP_Text>();
+					text.font = ModManager.Instance.zhCNFont;
 				}
 				return text;
 			}
diff --git a/DeckBuilderWidget.cs b/DeckBuilderWidget.cs
index a6e7449..619bb3b 100644
--- a/DeckBuilderWidget.cs
+++ b/DeckBuilderWidget.cs
@@ -3403,62 +3403,14 @@ public class DeckBuilderWidget : MonoBehaviour, IFindActionHandler
 		{
 			cards = filteredMainDeck.Concat(filteredCommandZone);
 		}
-		Dictionary<ManaColor, uint> dictionary = BasicLandSuggester.Calculate(cards, _context.Format);
-		Dictionary<ManaColor, List<uint>> dictionary2 = new Dictionary<ManaColor, List<uint>>
-		{
-			{
-				ManaColor.ManaColor_White,
-				new List<uint>()
-			},
-			{
-				ManaColor.ManaColor_Blue,
-				new List<uint>()
-			},
-			{
-				ManaColor.ManaColor_Black,
-				new List<uint>()
-			},
-			{
-				ManaColor.ManaColor_Red,
-				new List<uint>()
-			},
-			{
-				ManaColor.ManaColor_Green,
-				new List<uint>()
-			},
-			{
-				ManaColor.ManaColor_None,
-				new List<uint>()
-			}
-		};
-		foreach (CardList.CardPrintingQuantity item in filteredMainDeck)
-		{
-			if (item.Printing.IsBasicLandUnlimited)
-			{
-				CardColor cardColor = item.Printing.ColorIdentity.FirstOrDefault();
-				if ((uint)(cardColor - 1) <= 4u && _inventoryManager.Cards.TryGetValue(item.Printing.GrpId, out var value) && value > 0)
-				{
-					ManaColor key = cardColor.ToManaColor();
-					for (int i = 0; i < item.Quantity; i++)
-					{
-						dictionary2[key].Add(item.Printing.GrpId);
-					}
-				}
-			}
-			else if (IsSuggestibleWaste(item))
-			{
-				for (int j = 0; j < item.Quantity; j++)
-				{
-					dictionary2[ManaColor.ManaColor_None].Add(item.Printing.GrpId);
-				}
-			}
-		}
+
+		Dictionary<ManaColor, uint> suggesContent = BasicLandSuggester.Calculate(cards, _context.Format);
 		List<uint> list = new List<uint>();
 		foreach (CardList.CardPrintingQuantity item2 in filteredMainDeck)
 		{
 			if (item2.Printing.IsBasicLandUnlimited || IsSuggestibleWaste(item2))
 			{
-				for (int k = 0; k < item2.Quantity; k++)
+				for (int j = 0; j < item2.Quantity; j++)
 				{
 					list.Add(item2.Printing.GrpId);
 				}
@@ -3468,31 +3420,58 @@ public class DeckBuilderWidget : MonoBehaviour, IFindActionHandler
 		{
 			_model.RemoveCardFromMainDeck(item3);
 		}
-		foreach (KeyValuePair<ManaColor, uint> item4 in dictionary)
+		foreach (KeyValuePair<ManaColor, uint> suggestion in suggesContent)
 		{
-			KeyValuePair<ManaColor, uint> kvp2 = item4;
-			DictionaryExtensions.Deconstruct(in kvp2, out var key2, out var value2);
-			ManaColor suggestionColor = key2;
-			uint num = value2;
+			ManaColor suggestionColor = suggestion.Key;
 			CardPrintingData cardPrintingData = null;
-			List<uint> list2 = dictionary2[suggestionColor];
-			for (int l = 0; l < num; l++)
+			uint defaultLandId = 0;
+			switch (suggestionColor)
 			{
-				if (l < list2.Count)
+				case ManaColor.ManaColor_White:
 				{
-					_model.AddCardToMainDeck(list2[l]);
-					continue;
+					defaultLandId = ModManager.Instance.config.plainsId;
+					break;
 				}
-				if (list2.Count > 0)
+				case ManaColor.ManaColor_Blue:
 				{
-					_model.AddCardToMainDeck(list2[list2.Count - 1]);
-					continue;
+					defaultLandId = ModManager.Instance.config.islandId;
+					break;
 				}
-				if (cardPrintingData == null)
+				case ManaColor.ManaColor_Black:
 				{
-					cardPrintingData = _cardDatabase.DatabaseUtilities.GetPrimaryPrintings().LastOrDefault((CardPrintingData kvp) => kvp.IsBasicLandUnlimited && kvp.ColorIdentity.FirstOrDefault().ToManaColor() == suggestionColor && _inventoryManager.Cards.TryGetValue(kvp.GrpId, out var value5) && value5 > 0);
+					defaultLandId = ModManager.Instance.config.swampId;
+					break;
+				}
+				case ManaColor.ManaColor_Red:
+				{
+					defaultLandId = ModManager.Instance.config.mountainId;
+					break;
+				}
+				case ManaColor.ManaColor_Green:
+				{
+					defaultLandId = ModManager.Instance.config.forestId;
+					break;
+				}
+				case ManaColor.ManaColor_None:
+				default:
+				{
+					if (this._context.IsConstructed)
+					{
+						defaultLandId = ModManager.Instance.config.wasteId;
+					}
+					else
+					{
+						defaultLandId = ModManager.Instance.config.plainsId;
+					}
+					break;
 				}
-				if (cardPrintingData == null && suggestionColor == ManaColor.ManaColor_None)
+			}
+
+			if (!_inventoryManager.Cards.TryGetValue(defaultLandId, out var cardQuantity) || (cardQuantity <= 0))
+			{
+				cardPrintingData = _cardDatabase.DatabaseUtilities.GetPrimaryPrintings().LastOrDefault((CardPrintingData kvp) => kvp.IsBasicLandUnlimited && kvp.ColorIdentity.FirstOrDefault().ToManaColor() == suggestion.Key && _inventoryManager.Cards.TryGetValue(kvp.GrpId, out var cardQuantity) && cardQuantity > 0);
+
+				if (cardPrintingData == null && key == ManaColor.ManaColor_None)
 				{
 					if (_context.IsConstructed)
 					{
@@ -3503,10 +3482,15 @@ public class DeckBuilderWidget : MonoBehaviour, IFindActionHandler
 						cardPrintingData = _cardDatabase.DatabaseUtilities.GetPrimaryPrintings().LastOrDefault((CardPrintingData kvp) => kvp.IsBasicLandUnlimited && kvp.ColorIdentity.FirstOrDefault().ToManaColor() == ManaColor.ManaColor_White && _inventoryManager.Cards.TryGetValue(kvp.GrpId, out var value3) && value3 > 0);
 					}
 				}
-				if (cardPrintingData != null)
+				if (cardPrintingData == null)
 				{
-					_model.AddCardToMainDeck(cardPrintingData.GrpId);
+					continue;
 				}
+				defaultLandId = cardPrintingData.GrpId
+			}
+			for (int k = 0; k < suggestion.Value; k++)
+			{
+				_model.AddCardToMainDeck(defaultLandId);
 			}
 		}
 		_model.UpdateMainDeck();
diff --git a/DeckMainTitlePanel.cs b/DeckMainTitlePanel.cs
index f191488..fc897e6 100644
--- a/DeckMainTitlePanel.cs
+++ b/DeckMainTitlePanel.cs
@@ -210,6 +210,11 @@ public class DeckMainTitlePanel : MonoBehaviour
 			{
 				AudioManager.PlayAudio(WwiseEvents.sfx_ui_filter_toggle, AudioManager.Default);
 			});
+			_formatDropdown.transform.Find("Text_NonSelected").GetComponentInChildren<TextMeshProUGUI>().font = ModManager.Instance.zhCNFont;
+		}
+		if (_nameInput != null)
+		{
+			_nameInput.textComponent.font = ModManager.Instance.zhCNFont;
 		}
 		_meshRendererReferenceLoaders = new MeshRendererReferenceLoader[_deckBoxRenderers.Length];
 		for (int i = 0; i < _deckBoxRenderers.Length; i++)
diff --git a/DeckManagerController.cs b/DeckManagerController.cs
index a6cb354..4208c4d 100644
--- a/DeckManagerController.cs
+++ b/DeckManagerController.cs
@@ -386,9 +386,13 @@ public class DeckManagerController : NavContentController
 	{
 		if (!_decksManager.ShowDeckLimitError())
 		{
-			string createsFormat = _deckBuckets[_selectedBucket].CreatesFormat;
-			Client_Deck deck = _formatManager.GetSafeFormat(createsFormat).NewDeck(_decksManager);
-			New_GoToDeckBuilder(deck, FormatUtilities.IsAmbiguous(createsFormat));
+			string formatName = _deckBuckets[_selectedBucket].CreatesFormat;
+			if (_selectedBucket == 0)
+			{
+				formatName = ModManager.Instance.config.defaultFormatName;
+			}
+			Client_Deck deck = _formatManager.GetSafeFormat(formatName).NewDeck(_decksManager);
+			New_GoToDeckBuilder(deck, FormatUtilities.IsAmbiguous(formatName));
 		}
 	}
 
diff --git a/DirectChallengeBladeWidget.cs b/DirectChallengeBladeWidget.cs
index 3d9987a..ec4b229 100644
--- a/DirectChallengeBladeWidget.cs
+++ b/DirectChallengeBladeWidget.cs
@@ -188,6 +188,7 @@ public class DirectChallengeBladeWidget : PlayBladeWidget
 		_selectDeckSlot.OnClick.AddListener(OnSelectDeckClicked);
 		_selectDeckButton.OnClick.AddListener(OnSelectDeckClicked);
 		LocalUsernameOutputter.onClick.AddListener(OnYourName_Clicked);
+		TournamentSettingsText.font = ModManager.Instance.zhCNFont;
 	}
 
 	private void OnEnable()
diff --git a/FriendChallengeBladeWidget.cs b/FriendChallengeBladeWidget.cs
index dfc44c7..4eba434 100644
--- a/FriendChallengeBladeWidget.cs
+++ b/FriendChallengeBladeWidget.cs
@@ -115,6 +115,7 @@ public class FriendChallengeBladeWidget : PlayBladeWidget
 			Languages.ActiveLocProvider.GetLocalizedText("MainNav/PrivateGame/Settings/StartingPlayer_Opponent")
 		});
 		_startingPlayerSpinner.SelectOption(0);
+		TournamentSettingsText.font = ModManager.Instance.zhCNFont;
 	}
 
 	private void Start()
diff --git a/GreClient.CardData/CardUtilities.cs b/GreClient.CardData/CardUtilities.cs
index 3a779c9..42b7df6 100644
--- a/GreClient.CardData/CardUtilities.cs
+++ b/GreClient.CardData/CardUtilities.cs
@@ -412,15 +412,7 @@ namespace GreClient.CardData
 
 		public static bool IsCardCraftable(CardPrintingData cardPrintingData)
 		{
-			if (cardPrintingData == null)
-			{
-				return false;
-			}
-			if (cardPrintingData.IsPrimaryCard && !cardPrintingData.IsBasicLand && !NonCollectibleCardList.Contains(cardPrintingData.GrpId) && !UnreleasedSets.Contains(cardPrintingData.ExpansionCode))
-			{
-				return !NonCraftableCardList.Contains(cardPrintingData.GrpId);
-			}
-			return false;
+			return true;
 		}
 
 		public static bool IsCardCollectible(CardPrintingData cardPrintingData)
diff --git a/MTGA.Loc/MTGALocalizable.cs b/MTGA.Loc/MTGALocalizable.cs
index 80f3eef..6d65c17 100644
--- a/MTGA.Loc/MTGALocalizable.cs
+++ b/MTGA.Loc/MTGALocalizable.cs
@@ -59,20 +59,7 @@ namespace MTGA.Loc
 				break;
 			case TargetType.Font:
 			{
-				FontMaterialMap localizedFont = fontProvider.GetLocalizedFont(locKey);
-				if (localizedFont == null)
-				{
-					break;
-				}
-				tMP_Text.font = localizedFont.font;
-				if (!string.IsNullOrEmpty(materialKey))
-				{
-					Material material = localizedFont.GetMaterial(materialKey);
-					if ((bool)material)
-					{
-						tMP_Text.fontSharedMaterial = material;
-					}
-				}
+				tMP_Text.font = ModManager.Instance.zhCNFont;
 				break;
 			}
 			default:
diff --git a/MatchManager.cs b/MatchManager.cs
index fbdace9..98592ce 100644
--- a/MatchManager.cs
+++ b/MatchManager.cs
@@ -58,11 +58,6 @@ public class MatchManager : IDisposable
 			set
 			{
 				_screenName = value;
-				int num = _screenName.LastIndexOf('#');
-				if (num != -1)
-				{
-					_screenName = _screenName.Substring(0, num);
-				}
 			}
 		}
 
diff --git a/Meta_CDC.cs b/Meta_CDC.cs
index ce12467..3e8d569 100644
--- a/Meta_CDC.cs
+++ b/Meta_CDC.cs
@@ -87,4 +87,15 @@ public class Meta_CDC : BASE_CDC
 		_matBlock = null;
 		base.OnDestroy();
 	}
+
+	public virtual void ShowCardRankInfo(bool active, string IWDInfo = "???")
+	{
+		_collectionAnchor.UpdateActive(active);
+		if (active)
+		{
+			_collectionCheckMark.UpdateActive(active: false);
+			_collectionText.transform.parent.gameObject.UpdateActive(active: true);
+			_collectionText.SetText(IWDInfo);
+		}
+	}
 }
diff --git a/ModManager.cs b/ModManager.cs
new file mode 100644
index 0000000..47ea973
--- /dev/null
+++ b/ModManager.cs
@@ -0,0 +1,295 @@
+using System;
+using System.Collections.Generic;
+using System.IO;
+using System.Net.Http;
+using System.Text;
+using TMPro;
+using UnityEngine;
+
+public class ModManager
+{
+	public enum UserSkillLevel : uint
+	{
+		NONE,
+		bottom,
+		middle,
+		top
+	}
+
+	public enum DraftDeckColor : uint
+	{
+		NONE,
+		W,
+		U,
+		B,
+		R,
+		G,
+		WU,
+		WB,
+		WR,
+		WG,
+		UB,
+		UR,
+		UG,
+		BR,
+		BG,
+		RG,
+		WUB,
+		WUR,
+		WUG,
+		WBR,
+		WBG,
+		WRG,
+		UBR,
+		UBG,
+		URG,
+		BRG,
+		WUBR,
+		WUBG,
+		WURG,
+		WBRG,
+		UBRG,
+		WUBRG
+	}
+
+	[Serializable]
+	public class ModConfig
+	{
+		public string fontName = "sourcehansans-medium";
+
+		public uint plainsId = 81179u;
+
+		public uint islandId = 81180u;
+
+		public uint swampId = 81181u;
+
+		public uint mountainId = 81182u;
+
+		public uint forestId = 81183u;
+
+		public string defaultFormatName = "Standard";
+
+		public bool displayIWDText = true;
+
+		public uint maxUntrustedIWDDataAmount = 200u;
+
+		public UserSkillLevel userSkillLevel;
+
+		public DraftDeckColor draftDeckColor;
+
+		public uint wasteId = 81179u;
+
+		public bool alwayExportEnglishDeck = false;
+	}
+
+	[Serializable]
+	private class CardInfo
+	{
+		public int seen_count;
+
+		public int pick_count;
+
+		public int game_count;
+
+		public int sideboard_game_count;
+
+		public int opening_hand_game_count;
+
+		public int drawn_game_count;
+
+		public int ever_drawn_game_count;
+
+		public int never_drawn_game_count;
+
+		public string name;
+
+		public string color;
+
+		public string rarity;
+
+		public string url;
+
+		public string url_back;
+
+		public double avg_seen;
+
+		public double avg_pick;
+
+		public double win_rate;
+
+		public double sideboard_win_rate;
+
+		public double opening_hand_win_rate;
+
+		public double drawn_win_rate;
+
+		public double ever_drawn_win_rate;
+
+		public double never_drawn_win_rate;
+
+		public double drawn_improvement_win_rate;
+	}
+
+	[Serializable]
+	private class CardInfoList
+	{
+		public List<CardInfo> data;
+	}
+
+	public TMP_FontAsset zhCNFont;
+
+	private static ModManager instance;
+
+	private static readonly object lockObj;
+
+	private static string configFilePath;
+
+	public ModConfig config;
+
+	private static Dictionary<string, Dictionary<string, double>> cardRankMap;
+
+	private static Dictionary<string, bool> fetchingTask;
+
+	private static string startDate;
+
+	private static string endDate;
+
+	private static string apiUri;
+
+	private static readonly HttpClient client;
+
+	public static ModManager Instance
+	{
+		get
+		{
+			lock (lockObj)
+			{
+				if (instance == null)
+				{
+					instance = new ModManager();
+					if (instance.config == null)
+					{
+						try
+						{
+							string json = File.ReadAllText(configFilePath, Encoding.UTF8);
+							instance.config = JsonUtility.FromJson<ModConfig>(json);
+							if (instance.config.userSkillLevel > UserSkillLevel.top)
+							{
+								instance.config.userSkillLevel = UserSkillLevel.NONE;
+							}
+							if (instance.config.draftDeckColor > DraftDeckColor.WUBRG)
+							{
+								instance.config.draftDeckColor = DraftDeckColor.NONE;
+							}
+							if (instance.config.userSkillLevel != 0)
+							{
+								apiUri = string.Format("{0}&user_group={1}", new object[2]
+								{
+									apiUri,
+									instance.config.userSkillLevel.ToString("G")
+								});
+							}
+							if (instance.config.draftDeckColor != 0)
+							{
+								apiUri = string.Format("{0&colors={1}", new object[2]
+								{
+									apiUri,
+									instance.config.draftDeckColor.ToString("G")
+								});
+							}
+						}
+						catch (Exception)
+						{
+							instance.config = new ModConfig();
+						}
+					}
+					if (instance.zhCNFont == null)
+					{
+						string fontName = instance.config.fontName;
+						AssetBundle assetBundle = AssetBundle.LoadFromFile(Application.dataPath + "/" + fontName);
+						if (assetBundle == null)
+						{
+							Debug.LogWarning(Application.dataPath + "/" + fontName + " don't exist");
+						}
+						instance.zhCNFont = assetBundle.LoadAsset<TMP_FontAsset>(fontName + " SDF");
+					}
+				}
+			}
+			return instance;
+		}
+	}
+
+	private ModManager()
+	{
+	}
+
+	public Dictionary<string, double> getCardRankMap(string setCode, string draftType)
+	{
+		if (!config.displayIWDText)
+		{
+			return null;
+		}
+		if (!cardRankMap.TryGetValue(setCode + "_" + draftType, out var value))
+		{
+			bool flag = false;
+			lock (lockObj)
+			{
+				flag = fetchingTask.ContainsKey(setCode + "_" + draftType);
+			}
+			if (!flag)
+			{
+				lock (lockObj)
+				{
+					fetchingTask[setCode + "_" + draftType] = true;
+				}
+				fetchCardRankInfo(setCode, draftType);
+			}
+			return null;
+		}
+		return value;
+	}
+
+	public async void fetchCardRankInfo(string setCode, string draftModeName)
+	{
+		string requestUri = string.Format(apiUri, setCode, draftModeName, startDate, endDate);
+		try
+		{
+			string json = $"{{ \"data\": {await client.GetStringAsync(requestUri)}}}";
+			CardInfoList cardInfoList = JsonUtility.FromJson<CardInfoList>(json);
+			if (cardInfoList != null)
+			{
+				Dictionary<string, double> dictionary = new Dictionary<string, double>();
+				foreach (CardInfo datum in cardInfoList.data)
+				{
+					if (datum.ever_drawn_game_count >= config.maxUntrustedIWDDataAmount || datum.never_drawn_game_count >= config.maxUntrustedIWDDataAmount)
+					{
+						double value = (datum.ever_drawn_win_rate - datum.never_drawn_win_rate) * 100.0;
+						dictionary[datum.name] = value;
+					}
+				}
+				cardRankMap[setCode + "_" + draftModeName] = dictionary;
+			}
+		}
+		catch (HttpRequestException)
+		{
+			Debug.LogWarning("fetch " + setCode + "_" + draftModeName + "card rank info failure.");
+		}
+		lock (lockObj)
+		{
+			fetchingTask.Remove(setCode + "_" + draftModeName);
+		}
+	}
+
+	static ModManager()
+	{
+		instance = null;
+		lockObj = new object();
+		configFilePath = Application.dataPath + "/modconfig.json";
+		cardRankMap = new Dictionary<string, Dictionary<string, double>>();
+		fetchingTask = new Dictionary<string, bool>();
+		startDate = "2016-09-01";
+		endDate = DateTime.Now.ToString("yyyy-MM-dd");
+		apiUri = "https://www.17lands.com/card_ratings/data?expansion={0}&format={1}&start_date={2}&end_date={3}";
+		client = new HttpClient();
+	}
+}
diff --git a/SearchAndFilterBar.cs b/SearchAndFilterBar.cs
index 3b52d89..c3e7959 100644
--- a/SearchAndFilterBar.cs
+++ b/SearchAndFilterBar.cs
@@ -110,6 +110,7 @@ public class SearchAndFilterBar : MonoBehaviour
 			AudioManager.PlayAudio(WwiseEvents.sfx_ui_generic_click, AudioManager.Default);
 			UpdateSearchText();
 		});
+		SearchInput.textComponent.font = ModManager.Instance.zhCNFont;
 		ClearSearchButton.onClick.AddListener(delegate
 		{
 			AudioManager.PlayAudio(WwiseEvents.sfx_ui_generic_click, AudioManager.Default);
diff --git a/SetCollectionScreenView.cs b/SetCollectionScreenView.cs
index c48ba2b..1f02792 100644
--- a/SetCollectionScreenView.cs
+++ b/SetCollectionScreenView.cs
@@ -133,6 +133,7 @@ public class SetCollectionScreenView : MonoBehaviour
 		_biCollectionNavigateStartTime = DateTime.Now;
 		_biActiveFilter = Filters.Default.ToString();
 		_biLogger = biLogger;
+		_setReleaseDate.font = ModManager.Instance.zhCNFont;
 	}
 
 	private void MoveToStore()
diff --git a/SettingsPanelGraphics.cs b/SettingsPanelGraphics.cs
index 6427585..4d4b9f2 100644
--- a/SettingsPanelGraphics.cs
+++ b/SettingsPanelGraphics.cs
@@ -319,7 +319,7 @@ public class SettingsPanelGraphics : SettingsMenuPanel
 			"es" => "Español", 
 			"fr" => "Français", 
 			"it" => "Italiano", 
-			"ja" => "日本語", 
+			"ja" => "简体中文", 
 			"ko" => "한국어", 
 			"pt-BR" => "Português\u00a0brasileiro", 
 			"ru" => "Русский", 
diff --git a/Spinner_OptionSelector.cs b/Spinner_OptionSelector.cs
index c3ddafd..cab44df 100644
--- a/Spinner_OptionSelector.cs
+++ b/Spinner_OptionSelector.cs
@@ -101,6 +101,7 @@ public class Spinner_OptionSelector : MonoBehaviour
 	{
 		_buttonNextValue.OnClick.AddListener(OnNextValue);
 		_buttonPreviousValue.OnClick.AddListener(OnPreviousValue);
+		_valueLabel.font = ModManager.Instance.zhCNFont;
 	}
 
 	private void Start()
diff --git a/StoreItemBase.cs b/StoreItemBase.cs
index 6595c75..d36d7c5 100644
--- a/StoreItemBase.cs
+++ b/StoreItemBase.cs
@@ -488,6 +488,7 @@ public class StoreItemBase : MonoBehaviour
 
 	public void SetLabelText(MTGALocalizedString text)
 	{
+		_label.GameObject.GetComponent<TextMeshProUGUI>().font = ModManager.Instance.zhCNFont;
 		SetOptionalObjectText(_label, text);
 	}
 
diff --git a/SystemMessageView.cs b/SystemMessageView.cs
index 0382116..77c3c52 100644
--- a/SystemMessageView.cs
+++ b/SystemMessageView.cs
@@ -66,6 +66,9 @@ public class SystemMessageView : MonoBehaviour, IKeyDownSubscriber, IKeySubscrib
 	{
 		_canvasGroup.blocksRaycasts = false;
 		_canvasGroup.alpha = 0f;
+		_titleText.font = ModManager.Instance.zhCNFont;
+		_messageText.font = ModManager.Instance.zhCNFont;
+		_detailsText.font = ModManager.Instance.zhCNFont;
 	}
 
 	public void Show()
diff --git a/Wotc.Mtga.CardParts.FieldFillers/CDCExtraFrameDetailFiller.cs b/Wotc.Mtga.CardParts.FieldFillers/CDCExtraFrameDetailFiller.cs
index 11dc368..b4d0975 100644
--- a/Wotc.Mtga.CardParts.FieldFillers/CDCExtraFrameDetailFiller.cs
+++ b/Wotc.Mtga.CardParts.FieldFillers/CDCExtraFrameDetailFiller.cs
@@ -43,6 +43,7 @@ namespace Wotc.Mtga.CardParts.FieldFillers
 			if (!_hasBeenInit)
 			{
 				_label = GetComponent<TMP_Text>();
+				_label.font = ModManager.Instance.zhCNFont;
 				_defaultFont = _label.font;
 				_defaultFontMaterial = _label.fontSharedMaterial;
 				_hasBeenInit = true;
diff --git a/Wotc.Mtga.CardParts.FieldFillers/FieldFillerUtils.cs b/Wotc.Mtga.CardParts.FieldFillers/FieldFillerUtils.cs
index b49db98..4624203 100644
--- a/Wotc.Mtga.CardParts.FieldFillers/FieldFillerUtils.cs
+++ b/Wotc.Mtga.CardParts.FieldFillers/FieldFillerUtils.cs
@@ -65,12 +65,16 @@ namespace Wotc.Mtga.CardParts.FieldFillers
 					if ((object)tMP_FontAsset != null)
 					{
 						canSwapMaterial = payload.CanSwapMaterial;
-						return tMP_FontAsset;
+						if (tMP_FontAsset.name.EndsWith("Phyrexian"))
+						{
+							return tMP_FontAsset;
+						}
+						return ModManager.Instance.zhCNFont;
 					}
 				}
 			}
 			canSwapMaterial = true;
-			return null;
+			return ModManager.Instance.zhCNFont;
 		}
 
 		public static Material FindMaterial(AssetLookupSystem als, AssetTracker tracker)
diff --git a/Wotc.Mtga.Cards.Parts.Textbox/ClassAbilityTextbox.cs b/Wotc.Mtga.Cards.Parts.Textbox/ClassAbilityTextbox.cs
index 111ac43..2e3b5a2 100644
--- a/Wotc.Mtga.Cards.Parts.Textbox/ClassAbilityTextbox.cs
+++ b/Wotc.Mtga.Cards.Parts.Textbox/ClassAbilityTextbox.cs
@@ -13,6 +13,11 @@ namespace Wotc.Mtga.Cards.Parts.Textbox
 		[SerializeField]
 		private TMP_Text _costLabel;
 
+        public void Awake()
+        {
+            _costLabel.font = ModManager.Instance.ZhCNFont;
+        }
+
 		public override float GetPreferredHeight()
 		{
 			return _header.rect.height;
diff --git a/Wotc.Mtga.Cards.Parts.Textbox/TableAbilityTextbox.cs b/Wotc.Mtga.Cards.Parts.Textbox/TableAbilityTextbox.cs
index afa904b..77aeb9c 100644
--- a/Wotc.Mtga.Cards.Parts.Textbox/TableAbilityTextbox.cs
+++ b/Wotc.Mtga.Cards.Parts.Textbox/TableAbilityTextbox.cs
@@ -21,6 +21,7 @@ namespace Wotc.Mtga.Cards.Parts.Textbox
 			{
 				Root = root;
 				Textfield = root.GetComponentInChildren<TMP_Text>();
+				Textfield.font = ModManager.Instance.zhCNFont;
 				Stripe = root.GetComponentInChildren<Image>();
 			}
 		}
@@ -100,7 +101,7 @@ namespace Wotc.Mtga.Cards.Parts.Textbox
 			{
 				if ((bool)row.Textfield)
 				{
-					row.Textfield.font = fontAsset;
+					row.Textfield.font = ModManager.Instance.zhCNFont;
 				}
 			}
 		}
diff --git a/Wotc.Mtga.Cards.Parts.Textbox/TextboxSubComponentBase.cs b/Wotc.Mtga.Cards.Parts.Textbox/TextboxSubComponentBase.cs
index 30a2da3..90dd7c4 100644
--- a/Wotc.Mtga.Cards.Parts.Textbox/TextboxSubComponentBase.cs
+++ b/Wotc.Mtga.Cards.Parts.Textbox/TextboxSubComponentBase.cs
@@ -47,7 +47,14 @@ namespace Wotc.Mtga.Cards.Parts.Textbox
 
 		public virtual void SetFont(TMP_FontAsset fontAsset)
 		{
-			_textLabel.font = fontAsset;
+			if (fontAsset.name.EndsWith("Phyrexian"))
+			{
+				_textLabel.font = fontAsset;
+			}
+			else
+			{
+				_textLabel.font = ModManager.Instance.zhCNFont;
+			}
 		}
 
 		public virtual void SetAlignment(TextAlignmentOptions textAlignment)
diff --git a/Wotc.Mtga.Cards.Text/Utilities.cs b/Wotc.Mtga.Cards.Text/Utilities.cs
index faea071..2e164a5 100644
--- a/Wotc.Mtga.Cards.Text/Utilities.cs
+++ b/Wotc.Mtga.Cards.Text/Utilities.cs
@@ -54,16 +54,7 @@ namespace Wotc.Mtga.Cards.Text
 
 		public static string GetBoldedAbilityText(string localizedText)
 		{
-			if (localizedText.Contains(". "))
-			{
-				return localizedText;
-			}
-			if (localizedText.Contains("—"))
-			{
-				string[] array = localizedText.Split('—');
-				return localizedText.Replace(array[0], $"<b>{array[0]}</b>");
-			}
-			return $"<b>{localizedText}</b>";
+			return localizedText;
 		}
 
 		public static bool TryStripLoyaltyPrefixFromString(ref string localizedText)
diff --git a/Wotc.Mtga.Loc/Languages.cs b/Wotc.Mtga.Loc/Languages.cs
index d250625..afd0e79 100644
--- a/Wotc.Mtga.Loc/Languages.cs
+++ b/Wotc.Mtga.Loc/Languages.cs
@@ -77,7 +77,7 @@ namespace Wotc.Mtga.Loc
 			"zh-TW"
 		};
 
-		public static readonly string[] ExternalLanguages = new string[9] { "en-US", "pt-BR", "fr-FR", "it-IT", "de-DE", "es-ES", "ru-RU", "ja-JP", "ko-KR" };
+		public static readonly string[] ExternalLanguages = new string[9] { "en-US", "ja-JP" };
 
 		public static readonly string[] CardLanguages = new string[10] { "en-US", "pt-BR", "fr-FR", "it-IT", "de-DE", "es-ES", "ru-RU", "ja-JP", "ko-KR", "phyrexian" };
 
diff --git a/Wotc.Mtga.Wrapper.Draft/DraftContentController.cs b/Wotc.Mtga.Wrapper.Draft/DraftContentController.cs
index 3d50dc3..291a570 100644
--- a/Wotc.Mtga.Wrapper.Draft/DraftContentController.cs
+++ b/Wotc.Mtga.Wrapper.Draft/DraftContentController.cs
@@ -709,9 +709,10 @@ namespace Wotc.Mtga.Wrapper.Draft
 
 		private void UpdateCardCollectionInfo(bool show)
 		{
-			foreach (DraftPackCardView cardView in _draftPackHolder.GetAllCardViews())
+			_showCollectionInfo = show;
+			if (!show)
 			{
-				if (show)
+				foreach (DraftPackCardView cardView in _draftPackHolder.GetAllCardViews())
 				{
 					_inventoryManager.Cards.TryGetValue(cardView.Card.GrpId, out var value);
 					value += _deck.MainDeckIds.Count((uint id) => id == cardView.Card.GrpId);
@@ -719,12 +720,28 @@ namespace Wotc.Mtga.Wrapper.Draft
 					int maxCollected = (int)cardView.Card.Printing.MaxCollected;
 					cardView.CardView.ShowCollectionInfo(active: true, Math.Min(value, maxCollected), maxCollected);
 				}
-				else
+				return;
+			}
+			if (_draftPod.InternalEventName == null)
+			{
+				return;
+			}
+			string[] array = _draftPod.InternalEventName.Split('_');
+			Dictionary<string, double> cardRankMap = ModManager.Instance.getCardRankMap(array[1], array[0]);
+			if (cardRankMap == null)
+			{
+				return;
+			}
+			foreach (DraftPackCardView allCardView in _draftPackHolder.GetAllCardViews())
+			{
+				string cardTitle = _cardDatabase.CardTitleProvider.GetCardTitle(allCardView.Card.GrpId, formatted: true, "en-US");
+				string iWDInfo = "???";
+				if (cardRankMap.TryGetValue(cardTitle, out var value2))
 				{
-					cardView.CardView.ShowCollectionInfo(active: false);
+					iWDInfo = ((!(value2 <= 0.0)) ? ("<color=\"green\"><size=90%>" + value2.ToString("F1")) : ("<color=\"red\"><size=90%>" + value2.ToString("F1")));
 				}
+				allCardView.CardView.ShowCardRankInfo(active: true, iWDInfo);
 			}
-			_showCollectionInfo = show;
 		}
 
 		private void UpdateWaitingOnPacksText()
@@ -904,6 +921,7 @@ namespace Wotc.Mtga.Wrapper.Draft
 		{
 			_settingCardsCoroutine = null;
 			_okToPickCard = true;
+			UpdateCardCollectionInfo(show: true);
 			StartCoroutine(Coroutine_StartTimer());
 		}
 
diff --git a/Wotc.Mtga.Wrapper.Draft/HumanDraftPod.cs b/Wotc.Mtga.Wrapper.Draft/HumanDraftPod.cs
index b8df756..2ed5432 100644
--- a/Wotc.Mtga.Wrapper.Draft/HumanDraftPod.cs
+++ b/Wotc.Mtga.Wrapper.Draft/HumanDraftPod.cs
@@ -63,6 +63,7 @@ namespace Wotc.Mtga.Wrapper.Draft
 			_biLogger = biLogger;
 			eventsServiceWrapper.AddDraftNotificationCallback(OnMsg_DraftNotification);
 			_eventId = eventId;
+			InternalEventName = eventId;
 			DraftState = DraftState.Podmaking;
 			DraftId = draftId;
 		}
diff --git a/WrapperDeckBuilder.cs b/WrapperDeckBuilder.cs
index fb77c9a..4853d30 100644
--- a/WrapperDeckBuilder.cs
+++ b/WrapperDeckBuilder.cs
@@ -239,7 +239,7 @@ public class WrapperDeckBuilder : NavContentController
 	{
 		if (!_decksManager.ShowDeckLimitError())
 		{
-			DeckBuilderContext context = new DeckBuilderContext(DeckServiceWrapperHelpers.ToAzureModel(_formatManager.GetDefaultFormat().NewDeck(_decksManager)), null, sideboarding: false, firstEdit: true, DeckBuilderMode.DeckBuilding, ambiguousFormat: true);
+			DeckBuilderContext context = new DeckBuilderContext(DeckServiceWrapperHelpers.ToAzureModel(_formatManager.GetSafeFormat(ModManager.Instance.config.defaultFormatName).NewDeck(_decksManager)), null, sideboarding: false, firstEdit: true, DeckBuilderMode.DeckBuilding, ambiguousFormat: true);
 			SceneLoader.GetSceneLoader().GoToDeckBuilder(context, reloadIfAlreadyLoaded: true);
 			AudioManager.PlayAudio(WwiseEvents.sfx_ui_generic_click, base.gameObject);
 		}
diff --git a/WrapperDeckUtilities.cs b/WrapperDeckUtilities.cs
index 0d5c56c..55c6304 100644
--- a/WrapperDeckUtilities.cs
+++ b/WrapperDeckUtilities.cs
@@ -263,30 +263,51 @@ public static class WrapperDeckUtilities
 
 	private static string GetMainLabel(IClientLocProvider localizationManager)
 	{
+		if (ModManager.Instance.config.alwayExportEnglishDeck)
+		{
+			return localizationManager.GetLocalizedTextForLanguage("MainNav/DeckBuilder/Deck_Label", "en-US");
+		}
 		return localizationManager.GetLocalizedText("MainNav/DeckBuilder/Deck_Label");
 	}
 
 	private static string GetSideboardLabel(IClientLocProvider localizationManager)
 	{
+		if (ModManager.Instance.config.alwayExportEnglishDeck)
+		{
+			return localizationManager.GetLocalizedTextForLanguage("MainNav/DeckBuilder/Sideboard_Label", "en-US");
+		}
 		return localizationManager.GetLocalizedText("MainNav/DeckBuilder/Sideboard_Label");
 	}
 
 	private static string GetCommanderLabel(IClientLocProvider localizationManager)
 	{
+		if (ModManager.Instance.config.alwayExportEnglishDeck)
+		{
+			return localizationManager.GetLocalizedTextForLanguage("MainNav/DeckBuilder/Commander", "en-US");
+		}
 		return localizationManager.GetLocalizedText("MainNav/DeckBuilder/Commander");
 	}
 
 	private static string GetCompanionLabel(IClientLocProvider localizationManager)
 	{
+		if (ModManager.Instance.config.alwayExportEnglishDeck)
+		{
+			return localizationManager.GetLocalizedTextForLanguage("MainNav/DeckBuilder/Companion", "en-US");
+		}
 		return localizationManager.GetLocalizedText("MainNav/DeckBuilder/Companion");
 	}
 
 	private static void ToExportString_BySection(StringBuilder builder, List<CardInDeck> cardCollection, ICardDatabaseAdapter db)
 	{
+		string overrideLanguageCode = null;
+		if (ModManager.Instance.config.alwayExportEnglishDeck)
+		{
+			overrideLanguageCode = "en-US";
+		}
 		foreach (CardInDeck item in cardCollection)
 		{
 			CardPrintingData cardPrintingById = db.CardDataProvider.GetCardPrintingById(item.Id);
-			builder.AppendLine(string.Format("{0} {1} ({2}) {3}", item.Quantity, (Languages.CurrentLanguage == "ja-JP") ? RemoveFurigana(db.GreLocProvider.GetLocalizedText(cardPrintingById.TitleId, null, formatted: false)) : db.GreLocProvider.GetLocalizedText(cardPrintingById.TitleId, null, formatted: false), cardPrintingById.ExpansionCode, cardPrintingById.CollectorNumber));
+			builder.AppendLine(string.Format("{0} {1} ({2}) {3}", item.Quantity, (Languages.CurrentLanguage == "ja-JP") ? RemoveFurigana(db.GreLocProvider.GetLocalizedText(cardPrintingById.TitleId, overrideLanguageCode, formatted: false)) : db.GreLocProvider.GetLocalizedText(cardPrintingById.TitleId, overrideLanguageCode, formatted: false), cardPrintingById.ExpansionCode, cardPrintingById.CollectorNumber));
 		}
 	}
 
@@ -535,7 +556,11 @@ public static class WrapperDeckUtilities
 
 	private static IReadOnlyList<CardPrintingData> GetPrintingsByLocalizedTitle(CardDatabase cardDatabase, string title)
 	{
-		IReadOnlyList<CardPrintingData> printingsByLocalizedTitle = cardDatabase.DatabaseUtilities.GetPrintingsByLocalizedTitle(title);
+		IReadOnlyList<CardPrintingData> printingsByLocalizedTitle = cardDatabase.DatabaseUtilities.GetPrintingsByEnglishTitle(title);
+		if (printingsByLocalizedTitle == null || printingsByLocalizedTitle.Count == 0)
+		{
+			printingsByLocalizedTitle = cardDatabase.DatabaseUtilities.GetPrintingsByLocalizedTitle(title);
+		}
 		if (printingsByLocalizedTitle != null)
 		{
 			CardPrintingData cardPrintingData = printingsByLocalizedTitle.FirstOrDefault((CardPrintingData c) => !c.IsPrimaryCard && c.DefunctRebalancedCardLink != 0 && cardDatabase.CardDataProvider.GetCardPrintingById(c.DefunctRebalancedCardLink).IsPrimaryCard);
-- 
2.39.1

